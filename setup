#!/bin/bash

# NOTE: REQUIRES SetupHelper v6.0 or later

# this script provides the following modificaitons:
#   move Settings and Notifications to the top of the list man page
#   hides the Tiles Overview
#   replaces the Mobile Overview with an enhanced version
#
# each of these modifications is optional and can be selected
#   at install time
#
# Note: both Enhanced Mobile Overview and hiding the Tile Overview modify main.qml
# so order of operations is important.
# The code also relies on a second request to backup an active file will not touch an existing backup

# enhanced generator control and display is part of GuiMods now so GeneratorConnector must not be installed also

################################################################################################################
# check to see if SetupHelper is at least v6.0 - exit if not
# this is done without use of any SetupHelper script extensions
scriptDir="$( cd "$(dirname $0)" >/dev/null 2>&1 ; /bin/pwd -P )"
packageName=$( basename $scriptDir )
setupHelperVersionFile="/data/SetupHelper/version"
if ! [ -f "$setupHelperVersionFile" ]; then
	echo "$packageName: SetupHelper version not found - can't continue" | tee -a "/data/log/SetupHelper"
	exit $EXIT_ERROR
else
	version=$( cat "$setupHelperVersionFile" )
	major=$( echo ${version:1} | awk -F. '{print $1}')
	if (( major < 6 )); then
		echo "$packageName: SetupHelper $version found must be v6.0 or newer - can't continue" | tee -a "/data/log/SetupHelper"
		dbus -y com.victronenergy.packageManager /GuiEditStatus SetValue "$packageName requires SetupHelper v6.0" > /dev/null
		sleep 5
		exit 255
	fi
fi
################################################################################################################

#### following lines incorporate SetupHelper utilities into this script
# Refer to the SetupHelper ReadMe file for details.

source "/data/SetupHelper/CommonResources"

#### end of lines to include SetupHelper

#### running manually and OK to proceed - prompt for input
if [ $scriptAction == 'NONE' ] ; then
    # display innitial message
    echo
    echo "This package modifies the GUI in several areas"
    echo "Refer to the ReadMe for an explaination of each modification"
    echo "Installation enables all modificaions by default"
    echo "  however each modificaiton can be enabled/disabled in the Display * language / GuiMods menus"

    standardActionPrompt
fi

#### installing
if [ $scriptAction == 'INSTALL' ] ; then

    # insure GeneratorConnector is uninstalled since its functionalty is now part of GuiMods
    if [ -f "$installedVersionPrefix""GeneratorConnector" ] || [ -f "$installedFlagPrefix""GeneratorConnector" ]; then
		logMessage "uninstalling the GeneratorConnector - GuiMods incorporates all it's features and more"
		if [ -e "/data/GeneratorConnector/setup" ]; then
			"/data/GeneratorConnector/setup" "uninstall" "auto" "deferReboot" "deferGuiRestart"
		else
			logMessage "WARNING can't uninstall GeneratorConnector - no package or no setup script"
		fi
		if [ -e "/data/settupOptions/GeneratorConnector" ]; then
			touch "/data/settupOptions/GeneratorConnector/DO_NOT_AUTO_INSTALL"
			touch "/data/settupOptions/GeneratorConnector/DO_NOT_AUTO_ADD"
			touch "/data/settupOptions/GeneratorConnector/FORCE_REMOVE"
		fi
    fi
fi

# endScript handles all uninstall tasks

# endScript will install or uninstall all files and dBus settings (package has no services)
# thats all folks - SCRIPT EXITS INSIDE THE FUNCTION
endScript 'INSTALL_FILES' 'ADD_DBUS_SETTINGS'
